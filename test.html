<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 2rem; text-align: center; }
    input, button, textarea { font-size: 1rem; padding: 0.4rem; margin: 0.4rem; }
    pre { background: #f4f4f4; padding: 1rem; border-radius: 8px; max-width: 800px; margin: 1rem auto; text-align: left; }
    .edit-box { display: flex; flex-direction: column; gap: 8px; margin: 1rem auto; width: 80%; max-width: 600px; }
    .edit-box div { display: flex; gap: 1rem; align-items: center; }
    .edit-box label { width: 180px; text-align: right; }
    .output-success { color: green; }
    #mainControls, #translationsEditor, #saveBtn, #output { display: none; }

    @media (max-width: 600px) {
      body { padding: 1rem; }
      .edit-box { width: 100%; }
      .edit-box div { flex-direction: column; align-items: stretch; }
      .edit-box label { width: 100%; text-align: left; }
      input, button, textarea { width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body onload="initUI()">
  <!-- Token input and auth -->
  <div id="tokenInputContainer">
    <input type="password" id="tokenInput" placeholder="Enter Bearer Token" />
    <button onclick="saveToken()">Authorize</button>
  </div>

  <!-- Controls (hidden initially) -->
  <div id="mainControls">
    <button onclick="getPrevWord()">Get Previous Word</button>
    <input type="text" id="wordId" placeholder="Enter ID or Word" />
    <button onclick="getWord()">Get Word</button>
    <button onclick="getNextWord()">Get Next Word</button>
  </div>

  <!-- Editor -->
  <div id="translationsEditor" class="edit-box"></div>
  <button id="saveBtn" onclick="saveTranslations()">Save Translations</button>

  <!-- Status output -->
  <div id="serverStatus" style="margin-top: 1rem;"></div>
  <pre id="output"></pre>

  <script>
    function initUI() {
      document.getElementById("tokenInputContainer").style.display = "block";
      document.getElementById("mainControls").style.display = "none";
      document.getElementById("translationsEditor").style.display = "none";
      document.getElementById("saveBtn").style.display = "none";
      document.getElementById("output").style.display = "none";
      document.getElementById("serverStatus").textContent = "";

      // Auto-authenticate if token exists in localStorage
      if (localStorage.getItem('bearerToken')) {
        checkServerStatus();
      }
    }

    function saveToken() {
      const token = document.getElementById('tokenInput').value;
      localStorage.setItem('bearerToken', token);
      checkServerStatus();
    }

    async function checkServerStatus() {
      const token = localStorage.getItem('bearerToken');
      const status = document.getElementById('serverStatus');

      if (!token) {
        status.textContent = "⚠️ Token not set";
        status.style.color = "orange";
        return;
      }

      try {
        const res = await fetch("https://213.89.2.214/api/ping", {
          headers: { "Authorization": "Bearer " + token }
        });

        if (res.ok) {
          document.getElementById("tokenInputContainer").style.display = "none";
          document.getElementById("mainControls").style.display = "block";
          status.textContent = "✅ Connected to server.";
          status.style.color = "green";
        } else {
          status.textContent = "❌ Server is down. Contact Atif the Admin.";
          status.style.color = "red";
        }
      } catch (err) {
        status.textContent = "❌ Server is down. Contact Atif the Admin.";
        status.style.color = "red";
      }
    }

    function getPrevWord() {
      const input = document.getElementById('wordId');
      let id = parseInt(input.value || '0', 10);
      if (isNaN(id)) id = 0;
      input.value = id - 1;
      getWord();
    }

    function getNextWord() {
      const input = document.getElementById('wordId');
      let id = parseInt(input.value || '0', 10);
      if (isNaN(id)) id = 0;
      input.value = id + 1;
      getWord();
    }

    async function getWord() {
      const token = localStorage.getItem('bearerToken');
      const id = document.getElementById('wordId').value;
      const output = document.getElementById('output');
      const editor = document.getElementById('translationsEditor');
      const saveBtn = document.getElementById('saveBtn');

      if (!token) {
        output.textContent = "❌ Please authorize first.";
        output.style.display = "block";
        return;
      }

      editor.style.display = "none";
      saveBtn.style.display = "none";
      output.style.display = "none";
      editor.innerHTML = "";

      try {
        const res = await fetch(`https://213.89.2.214/api/words/${id}`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) throw new Error("Unauthorized or Not Found");

        const data = await res.json();

        document.getElementById('wordId').value = data.id;

        if (data.translations && typeof data.translations === 'string') {
          const parsed = JSON.parse(data.translations);
          const displayOrder = [
            'wordClass',
            'en_US word',
            'ur_PK word',
            'en_US sentence',
            'ur_PK sentence'
          ];

          displayOrder.forEach(key => {
            const value = parsed[key] ?? '';
            const isReadOnly = key === 'wordClass' || key === 'en_US word';
            const row = document.createElement('div');

            const labelEl = document.createElement('label');
            labelEl.textContent = key;

            const inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.name = key;
            inputEl.value = value;
            if (isReadOnly) inputEl.setAttribute('readonly', true);

            const playBtn = document.createElement('button');
            playBtn.type = 'button';
            playBtn.textContent = '▶';
            playBtn.addEventListener('click', () => playText(key, inputEl.value));

            row.appendChild(labelEl);
            row.appendChild(inputEl);
            row.appendChild(playBtn);
            editor.appendChild(row);
          });

          editor.style.display = "flex";
          saveBtn.style.display = "inline-block";
        }
      } catch (err) {
        output.textContent = "❌ Error: " + err.message;
        output.style.display = "block";
      }
    }

    async function saveTranslations() {
      const inputs = document.querySelectorAll('#translationsEditor input');
      const updated = {};
      inputs.forEach(input => {
        updated[input.name] = input.value;
      });

      const jsonString = JSON.stringify(updated);
      const output = document.getElementById('output');
      const token = localStorage.getItem('bearerToken');
      const id = parseInt(document.getElementById('wordId').value, 10);

      if (!token || !id || isNaN(id)) {
        output.style.display = "block";
        output.textContent = "❌ Cannot save: missing token or valid ID.";
        return;
      }

      try {
        const res = await fetch("https://213.89.2.214/api/words/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            id: id,
            translations: jsonString
          })
        });

        const resultText = await res.text();
        output.style.display = "block";
        output.textContent = res.ok
          ? "✅ Translations saved: " + resultText
          : "❌ Save failed: " + resultText;
      } catch (err) {
        output.style.display = "block";
        output.textContent = "❌ Error: " + err.message;
      }
    }

    function playText(key, text) {
      if (!window.speechSynthesis) return;

      const prefix = key.split(' ')[0];
      const requestedLang = prefix.includes('_')
        ? prefix.replace('_', '-')
        : 'en-US';

      const voices = speechSynthesis.getVoices();
      if (!voices.length) {
        speechSynthesis.onvoiceschanged = () => playText(key, text);
        return;
      }

      const utter = new SpeechSynthesisUtterance(text);
      let voice = voices.find(v => v.lang === requestedLang);
      if (!voice) {
        const base = requestedLang.split('-')[0];
        voice = voices.find(v => v.lang.startsWith(base));
      }
      if (voice) {
        utter.voice = voice;
        utter.lang = voice.lang;
      } else {
        utter.lang = requestedLang;
      }

      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    document.addEventListener("DOMContentLoaded", () => {
  const tokenInput = document.getElementById("tokenInput");
  const wordIdInput = document.getElementById("wordId");

  tokenInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      document.querySelector("#tokenInputContainer button").click();
    }
  });

  wordIdInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      document.querySelector("#mainControls button:nth-of-type(2)").click();
    }
  });
});

  </script>
</html>
